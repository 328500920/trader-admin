# 角色权限改造方案

## 一、需求背景

系统需要支持三种角色：管理员、讲师、学员，实现不同角色的权限控制。

## 二、角色定义

| 角色 | 标识 | 说明 |
|-----|------|------|
| 管理员 | admin | 平台最高权限，可进行任何操作 |
| 讲师 | teacher | 管理课程内容，查看学员数据（只读） |
| 学员 | student | 默认角色，只能操作自己的数据 |

## 三、菜单权限矩阵

| 菜单 | 管理员 | 讲师 | 学员 |
|-----|-------|------|------|
| 首页 | ✅ | ✅ | ✅ |
| 学习中心 | ✅ | ✅ | ✅ |
| 交易日志 | ✅ | ✅ | ✅ |
| 社区 | ✅ | ✅ | ✅ |
| 心理日记 | ✅ | ✅ | ✅ |
| 术语词典 | ✅ | ✅ | ✅ |
| 工具箱 | ✅ | ✅ | ✅ |
| **学员管理** | ✅ | ✅ | ❌ |
| **课程管理** | ✅ | ✅ | ❌ |
| **用户管理** | ✅ | ❌ | ❌ |

## 四、功能权限说明

### 4.1 管理员
- 所有功能的完全访问权限
- 用户管理：增删改查所有用户，指定用户角色
- 课程管理：增删改查课程、章节、资料、测验、案例
- 学员管理：查看所有学员数据

### 4.2 讲师
- 课程管理：增删改查课程、章节、资料、测验、案例
- 学员管理：查看学员列表、学员学习进度、学员交易日志（只读）
- 学习功能：可以使用学习中心等功能（自己学习）
- 不能：管理用户、修改学员数据

### 4.3 学员
- 学习功能：学习中心、交易日志、心理日记等
- 数据隔离：只能查看和操作自己的数据
- 不能：访问学员管理、课程管理、用户管理

## 五、数据库改造

### 5.1 用户表增加角色字段

```sql
-- 增加角色字段
ALTER TABLE sys_user ADD COLUMN role VARCHAR(20) DEFAULT 'student' 
    COMMENT '角色: admin/teacher/student';

-- 创建索引
ALTER TABLE sys_user ADD INDEX idx_role (role);

-- 更新现有数据为学员
UPDATE sys_user SET role = 'student' WHERE role IS NULL;

-- 设置管理员（根据实际情况修改ID）
UPDATE sys_user SET role = 'admin' WHERE id = 1;
```

## 六、后端改造

### 6.1 修改用户实体

文件：`SysUser.java`

```java
// 增加字段
private String role; // 角色: admin/teacher/student
```

### 6.2 修改登录返回

登录成功后返回用户角色信息，前端根据角色控制菜单显示。

### 6.3 新增权限注解

```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    String[] value(); // 允许的角色列表
}
```

### 6.4 新增权限拦截器

```java
@Component
public class RoleInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 检查方法上的 @RequireRole 注解
        // 验证当前用户角色是否在允许列表中
    }
}
```

### 6.5 新增学员管理接口

| 接口 | 方法 | 说明 | 权限 |
|-----|------|------|------|
| /student/list | GET | 学员列表（分页） | admin, teacher |
| /student/{id} | GET | 学员详情 | admin, teacher |
| /student/{id}/progress | GET | 学员学习进度 | admin, teacher |
| /student/{id}/trade | GET | 学员交易日志 | admin, teacher |
| /student/{id}/checkin | GET | 学员打卡记录 | admin, teacher |

### 6.6 课程管理接口权限

现有课程管理相关接口增加角色校验：
- `/system/course/**` → 需要 admin 或 teacher 角色

## 七、前端改造

### 7.1 Store 增加角色信息

```javascript
// store/user.js
state: {
  role: '', // admin/teacher/student
  roles: [] // 兼容数组形式
}
```

### 7.2 路由权限配置

```javascript
// router/index.js
{
  path: 'student',
  name: 'StudentManage',
  component: () => import('@/views/student/index.vue'),
  meta: { 
    title: '学员管理', 
    icon: 'User',
    roles: ['admin', 'teacher'] 
  }
},
{
  path: 'course-manage',
  name: 'CourseManage',
  meta: { 
    title: '课程管理', 
    icon: 'Reading',
    roles: ['admin', 'teacher'] 
  },
  children: [
    { path: 'course', name: 'CourseList', meta: { title: '课程列表' } },
    { path: 'chapter', name: 'ChapterList', meta: { title: '章节管理' } },
    { path: 'material', name: 'MaterialList', meta: { title: '学习资料' } },
    { path: 'quiz', name: 'QuizList', meta: { title: '测验题目' } },
    { path: 'case', name: 'CaseList', meta: { title: '实战案例' } }
  ]
},
{
  path: 'system',
  name: 'System',
  meta: { 
    title: '系统管理', 
    icon: 'Setting',
    roles: ['admin'] 
  },
  children: [
    { path: 'user', name: 'UserManage', meta: { title: '用户管理' } }
  ]
}
```

### 7.3 路由守卫权限校验

```javascript
// router/index.js beforeEach
if (to.meta.roles && !to.meta.roles.includes(userStore.role)) {
  next('/403') // 或跳转首页
  return
}
```

### 7.4 新增页面

| 页面 | 路径 | 说明 |
|-----|------|------|
| 学员列表 | views/student/index.vue | 学员列表，支持搜索、分页 |
| 学员详情 | views/student/detail.vue | Tab形式展示学习进度、交易日志等 |

### 7.5 菜单结构

```
├── 首页
├── 学习中心
│   ├── 课程列表
│   ├── 专题学习
│   ├── 章节测验
│   ├── 实战案例
│   ├── K线形态图鉴
│   ├── 工具指南
│   ├── 学习资源
│   ├── 学习进度
│   ├── 我的笔记
│   ├── 错题本
│   └── 我的收藏
├── 交易日志
│   ├── 交易记录
│   ├── 成交记录
│   ├── 交易计划
│   └── 绩效分析
├── 社区
├── 心理日记
├── 术语词典
├── 工具箱
├── 学员管理 ← 新增（admin/teacher）
├── 课程管理 ← 新增（admin/teacher）
│   ├── 课程列表
│   ├── 章节管理
│   ├── 学习资料
│   ├── 测验题目
│   └── 实战案例
└── 系统管理（admin）
    └── 用户管理
```

## 八、开发任务清单

### 第一阶段：基础权限

- [x] 数据库：sys_user 表增加 role 字段
- [x] 后端：SysUser 实体增加 role 字段
- [x] 后端：登录接口返回角色信息
- [x] 后端：新增 @RequireRole 注解和拦截器
- [x] 前端：Store 存储角色信息
- [x] 前端：路由守卫权限校验
- [x] 前端：菜单根据角色动态显示

### 第二阶段：学员管理

- [x] 后端：学员管理 Controller/Service
- [x] 后端：学员列表接口
- [x] 后端：学员详情接口（进度、交易日志等）
- [x] 前端：学员列表页面
- [x] 前端：学员详情页面

### 第三阶段：课程管理

- [x] 后端：课程管理接口权限校验
- [x] 前端：课程管理菜单调整
- [ ] 前端：课程管理页面（如果需要新增）

## 九、注意事项

1. **数据安全**：学员只能访问自己的数据，后端必须校验 user_id
2. **接口安全**：敏感接口必须校验角色权限
3. **向后兼容**：现有用户默认为学员角色
4. **测试覆盖**：权限相关功能需要充分测试
