# 菜单权限动态配置方案

## 一、需求背景

当前系统的菜单权限是通过前端路由配置中的 `meta.roles` 静态控制的，存在以下问题：

1. 修改菜单权限需要改代码、重新部署
2. 无法灵活控制某个菜单对特定角色的可见性
3. 管理员无法自主管理菜单配置

**目标**：实现菜单权限的动态配置，管理员可以在后台界面灵活控制每个菜单对不同角色的可见性。

## 二、角色说明

| 角色 | 标识 | 菜单权限 |
|-----|------|---------|
| 管理员 | admin | 可以看到所有菜单，可以管理菜单配置 |
| 教师 | teacher | 只能看到配置了 teacher 权限的菜单 |
| 学员 | student | 只能看到配置了 student 权限的菜单 |

## 三、数据库设计

### 3.1 菜单表 sys_menu

```sql
CREATE TABLE sys_menu (
  id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '菜单ID',
  parent_id BIGINT DEFAULT 0 COMMENT '父菜单ID，0表示顶级菜单',
  menu_key VARCHAR(50) NOT NULL COMMENT '菜单唯一标识，对应前端路由name',
  menu_name VARCHAR(50) NOT NULL COMMENT '菜单显示名称',
  path VARCHAR(100) COMMENT '路由路径',
  icon VARCHAR(50) COMMENT '菜单图标',
  sort_order INT DEFAULT 0 COMMENT '排序序号，越小越靠前',
  visible TINYINT DEFAULT 1 COMMENT '是否显示：1-显示 0-隐藏（全局隐藏）',
  role_admin TINYINT DEFAULT 1 COMMENT '管理员可见：1-是 0-否',
  role_teacher TINYINT DEFAULT 1 COMMENT '教师可见：1-是 0-否',
  role_student TINYINT DEFAULT 1 COMMENT '学员可见：1-是 0-否',
  remark VARCHAR(200) COMMENT '备注',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_menu_key (menu_key)
) COMMENT='系统菜单表';
```

### 3.2 字段说明

| 字段 | 说明 |
|-----|------|
| menu_key | 菜单唯一标识，与前端路由的 name 对应 |
| parent_id | 父菜单ID，用于构建菜单树结构 |
| visible | 全局开关，0时所有角色都看不到 |
| role_admin | 管理员是否可见（实际上管理员始终可见，此字段仅作记录） |
| role_teacher | 教师是否可见 |
| role_student | 学员是否可见 |

### 3.3 初始化数据

```sql
-- 顶级菜单
INSERT INTO sys_menu (id, parent_id, menu_key, menu_name, path, icon, sort_order, role_admin, role_teacher, role_student) VALUES
(1, 0, 'Dashboard', '首页', '/dashboard', 'HomeFilled', 1, 1, 1, 1),
(2, 0, 'Learn', '学习中心', '/learn', 'Reading', 2, 1, 1, 1),
(3, 0, 'Trade', '交易日志', '/trade', 'TrendCharts', 3, 1, 1, 1),
(4, 0, 'Psychology', '心理日记', '/psychology', 'Memo', 4, 1, 1, 1),
(5, 0, 'StudentManage', '学员管理', '/student', 'User', 5, 1, 1, 0),
(6, 0, 'CourseManageMenu', '课程管理', '/course-manage', 'Reading', 6, 1, 1, 0),
(7, 0, 'System', '系统管理', '/system', 'Setting', 7, 1, 0, 0);

-- 学习中心子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(2, 'CourseList', '课程列表', 'course', 1, 1, 1, 1),
(2, 'TopicList', '专题学习', 'topic', 2, 1, 1, 1),
(2, 'QuizList', '章节测验', 'quiz', 3, 1, 1, 1),
(2, 'VideoList', '视频课程', 'video', 4, 1, 1, 1),
(2, 'CaseList', '实战案例', 'case', 5, 1, 1, 1),
(2, 'Patterns', 'K线形态图鉴', 'patterns', 6, 1, 1, 1),
(2, 'ToolGuideList', '工具指南', 'tool-guide', 7, 1, 1, 1),
(2, 'ResourceList', '学习资源', 'resource', 8, 1, 1, 1),
(2, 'Progress', '学习进度', 'progress', 9, 1, 1, 1),
(2, 'NoteList', '我的笔记', 'note', 10, 1, 1, 1),
(2, 'WrongBook', '错题本', 'wrong-book', 11, 1, 1, 1),
(2, 'Favorite', '我的收藏', 'favorite', 12, 1, 1, 1);

-- 交易日志子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(3, 'TradeList', '交易记录', 'list', 1, 1, 1, 1),
(3, 'TradeRecord', '成交记录', 'record', 2, 1, 1, 1),
(3, 'TradePlan', '交易计划', 'plan', 3, 1, 1, 1),
(3, 'TradeXray', '交易X光', 'xray', 4, 1, 1, 1),
(3, 'TradeAnalysis', '绩效分析', 'analysis', 5, 1, 1, 1);

-- 心理日记子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(4, 'PsychologyIndex', '情绪打卡', 'index', 1, 1, 1, 1),
(4, 'PsychologyAnalysis', '情绪分析', 'analysis', 2, 1, 1, 1);

-- 学员管理子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(5, 'StudentList', '学员列表', 'list', 1, 1, 1, 0);

-- 课程管理子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(6, 'CourseManageList', '课程列表', 'course', 1, 1, 1, 0),
(6, 'VideoManage', '视频课程管理', 'video', 2, 1, 1, 0);

-- 系统管理子菜单
INSERT INTO sys_menu (parent_id, menu_key, menu_name, path, sort_order, role_admin, role_teacher, role_student) VALUES
(7, 'UserManage', '用户管理', 'user', 1, 1, 0, 0),
(7, 'AiModelManage', 'AI模型管理', 'ai-model', 2, 1, 0, 0),
(7, 'MenuManage', '菜单管理', 'menu', 3, 1, 0, 0);
```

## 四、后端设计

### 4.1 实体类 SysMenu

```java
@Data
@TableName("sys_menu")
public class SysMenu {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long parentId;
    private String menuKey;
    private String menuName;
    private String path;
    private String icon;
    private Integer sortOrder;
    private Integer visible;
    private Integer roleAdmin;
    private Integer roleTeacher;
    private Integer roleStudent;
    private String remark;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
    
    @TableField(exist = false)
    private List<SysMenu> children; // 子菜单
}
```

### 4.2 接口设计

| 接口 | 方法 | 说明 | 权限 |
|-----|------|------|------|
| /api/menu/user | GET | 获取当前用户可见菜单 | 登录用户 |
| /api/menu/list | GET | 获取所有菜单（树形） | admin |
| /api/menu/{id} | PUT | 更新菜单配置 | admin |
| /api/menu/batch | PUT | 批量更新菜单 | admin |

### 4.3 核心逻辑

**获取用户菜单逻辑：**

```java
public List<SysMenu> getUserMenus(String role) {
    List<SysMenu> allMenus = menuMapper.selectList(
        new QueryWrapper<SysMenu>()
            .eq("visible", 1)
            .orderByAsc("sort_order")
    );
    
    // 管理员返回所有可见菜单
    if ("admin".equals(role)) {
        return buildMenuTree(allMenus);
    }
    
    // 其他角色根据权限过滤
    List<SysMenu> filtered = allMenus.stream()
        .filter(menu -> {
            if ("teacher".equals(role)) return menu.getRoleTeacher() == 1;
            if ("student".equals(role)) return menu.getRoleStudent() == 1;
            return false;
        })
        .collect(Collectors.toList());
    
    return buildMenuTree(filtered);
}
```

## 五、前端设计

### 5.1 菜单获取流程

```
用户登录 → 获取用户信息(含角色) → 调用 /api/menu/user → 存储到 Store → 渲染侧边栏
```

### 5.2 Store 改造

```javascript
// store/user.js
state: {
  menus: [], // 用户可见菜单
},
actions: {
  async loadMenus() {
    const res = await getUserMenus()
    this.menus = res.data
  }
}
```

### 5.3 侧边栏改造

将侧边栏从静态路由渲染改为根据 `store.menus` 动态渲染：

```vue
<template>
  <el-menu>
    <template v-for="menu in userStore.menus">
      <el-sub-menu v-if="menu.children?.length" :index="menu.path">
        <template #title>
          <el-icon><component :is="menu.icon" /></el-icon>
          <span>{{ menu.menuName }}</span>
        </template>
        <el-menu-item v-for="child in menu.children" :index="child.path">
          {{ child.menuName }}
        </el-menu-item>
      </el-sub-menu>
      <el-menu-item v-else :index="menu.path">
        <el-icon><component :is="menu.icon" /></el-icon>
        <span>{{ menu.menuName }}</span>
      </el-menu-item>
    </template>
  </el-menu>
</template>
```

### 5.4 菜单管理页面

新增 `views/system/menu/index.vue`，功能：

1. 树形表格展示所有菜单
2. 开关控制 visible（全局显示/隐藏）
3. 复选框控制各角色可见性
4. 支持拖拽排序（可选）

**界面示意：**

| 菜单名称 | 显示 | 管理员 | 教师 | 学员 | 操作 |
|---------|------|-------|------|------|------|
| 首页 | ✅ | ✅ | ✅ | ✅ | 编辑 |
| 学习中心 | ✅ | ✅ | ✅ | ✅ | 编辑 |
| ├─ 课程列表 | ✅ | ✅ | ✅ | ✅ | 编辑 |
| ├─ 视频课程 | ✅ | ✅ | ✅ | ✅ | 编辑 |
| 交易日志 | ✅ | ✅ | ✅ | ✅ | 编辑 |
| ├─ 交易X光 | ✅ | ✅ | ✅ | ❌ | 编辑 |
| 学员管理 | ✅ | ✅ | ✅ | ❌ | 编辑 |
| 系统管理 | ✅ | ✅ | ❌ | ❌ | 编辑 |

## 六、路由守卫改造

前端路由守卫需要配合改造，防止用户直接访问无权限的路由：

```javascript
router.beforeEach(async (to, from, next) => {
  // ... 登录检查 ...
  
  // 检查菜单权限
  const userStore = useUserStore()
  const allowedKeys = getAllMenuKeys(userStore.menus) // 递归获取所有 menuKey
  
  // 如果路由 name 不在允许列表中，且不是公共页面
  if (to.name && !allowedKeys.includes(to.name) && !isPublicRoute(to)) {
    // 管理员放行
    if (userStore.role === 'admin') {
      next()
      return
    }
    // 其他角色跳转首页
    next('/dashboard')
    return
  }
  
  next()
})
```

## 七、开发任务清单

### 第一阶段：后端

- [ ] 创建 sys_menu 表
- [ ] 创建 SysMenu 实体类
- [ ] 创建 SysMenuMapper
- [ ] 创建 SysMenuService（获取用户菜单、菜单管理）
- [ ] 创建 SysMenuController
- [ ] 初始化菜单数据

### 第二阶段：前端

- [ ] 创建 menu.js API
- [ ] 改造 userStore，增加 menus 和 loadMenus
- [ ] 改造侧边栏组件，动态渲染菜单
- [ ] 改造路由守卫，增加菜单权限校验
- [ ] 创建菜单管理页面

### 第三阶段：测试

- [ ] 测试管理员菜单显示
- [ ] 测试教师菜单显示
- [ ] 测试学员菜单显示
- [ ] 测试菜单配置修改
- [ ] 测试直接访问无权限路由

## 八、注意事项

1. **管理员特权**：管理员始终可以看到所有 visible=1 的菜单，不受角色配置限制
2. **缓存考虑**：菜单配置修改后，已登录用户需要刷新页面才能看到变化
3. **路由保护**：前端菜单隐藏只是视觉上的，后端接口仍需要 @RequireRole 保护
4. **子菜单联动**：如果父菜单对某角色不可见，其子菜单也应该不可见
5. **向后兼容**：保留前端路由配置，菜单数据只控制显示，路由跳转仍走原有逻辑

## 九、方案优缺点

### 优点

1. **灵活性高**：管理员可随时调整菜单权限，无需改代码
2. **可视化管理**：通过管理界面直观配置
3. **精细控制**：可以控制到每个子菜单级别
4. **易扩展**：未来新增角色只需加字段

### 缺点

1. **复杂度增加**：需要维护菜单数据表
2. **初始化工作**：需要把现有菜单导入数据库
3. **同步问题**：前端新增路由时需要同步更新数据库

## 十、替代方案

如果觉得数据库方案太重，也可以考虑**配置文件方案**：

将菜单权限配置放在 `application.yml` 中：

```yaml
menu:
  permissions:
    Dashboard: [admin, teacher, student]
    Learn: [admin, teacher, student]
    Trade: [admin, teacher, student]
    TradeXray: [admin, teacher]  # X光只对管理员和教师开放
    StudentManage: [admin, teacher]
    System: [admin]
```

这种方案更轻量，但修改需要重启服务。

---

请审阅以上方案，如有问题或需要调整的地方请告诉我。
